// TODO: error messages! things will go wrong!

$(document).ready(function(){
  
  // edit metadata
  
  // yeah... redesign this interface.
  $('#edit_metadata_link').click(function(){
    if($('#metadata').hasClass('currently_editing')) {
      // save metadata
      this.innerHTML = 'Saving...' // spinner would be nice
      $('#metadata').load('{{ url("/save_metadata/%s" % escape(pagename)) }}',
        $("textarea[name='metadata']").serializeArray(),
        function(){
          $('#edit_metadata_link').html('Edit')
          $('#metadata').removeClass()
        })
    } else {
      // swap metadata area for textarea
      this.innerHTML = 'Loading...'
      $('#metadata').addClass('currently_editing')
      $('#metadata').load('{{ url("/show/%s/metadata" % escape(pagename)) }}',
        function(){
          $('#edit_metadata_link').html('Save')
          $("textarea[name='metadata']").focus()
        })
    }
  })
  
  // edit description
  
  $('#description').dblclick(function(){
    $(this).removeAttr('title')
    $(this).load('{{ url("/edit_description/%s" % pagename) }}',function(){
      $('#save_description_button').click(function(){
        $('#description').load('{{ url("/save_description/%s" % pagename) }}',
          $('textarea[name="description"]').serializeArray(),
          function(){
            $('#description').attr('title','double-click to edit')
          })
      })
      $('#cancel_description_link').click(function(){
        $('#description').load('{{ url("/save_description/%s" % pagename) }}',
          function(){
            $(this).attr('title','double-click to edit')
          })
      })
    })
  })
  
  // delete link

  $('#delete_link').click(function(){
    $(this).hide()
    $('#delete_prompt').show()
  })
  $('#delete_no').click(function(){
    $('#delete_prompt').hide()
    $('#delete_link').show()
  })
  $('#delete_yes').click(function(){
    confirm('Are you sure? The description and metadata will be lost.')
  })
  
  // rename link

  $('#rename_link').click(function(){
    $(this).hide()
    $('#rename_form').show()
    $("input[name='newname']").focus()
  })
  $('#rename_cancel').click(function(){
    $("input[name='newname']").blur()
    $('#rename_form').hide()
    $('#rename_link').show()
  })

})
